# オリジナルプロジェクト考案書: logi-balance機能限定版（配達限定）

## 0. このアプリの概要

運送業界では、**配達コースごとの件数・個数・距離の偏り**がしばしば生じます。
この偏りが、ドライバー間の **業務負担や手当ての不公平感** につながり、職場の不満や早期離職の一因となっています。特に、発言力のあるベテランドライバーが負担の軽いコースを優先し、新人ドライバーに負担の大きい配達を任せる傾向が見られます。その結果、新人が十分に稼げず定着しにくいという課題があります。

そこで本アプリ「logi-balance」は、**コース間の配達負荷を可視化し、公平性を担保する仕組み**を提供します。
目的は、新人ドライバーが安心して働き続けられる環境をつくり、組織全体の定着率と効率性を高めることです。

---

### 前提条件

1. ドライバーの給料・手当の内訳には、**配達個数・集荷個数・能力給・年功序列・就労時間・販売奨励金**などが含まれる。
2. 一般的に **配達手当よりも集荷手当の方が高い**。
3. このため、ベテランが集荷を優先し、新人に配達を回す構造が生じやすい。
   → 本アプリでは、この不均衡を是正し、配分を「見える化」することで問題を抑制する。


## 1. 背景・課題
- **負担の偏り**：コースごとに負担が偏り、手当に不公平感が生じている。払拭されない不公平なコース割による新入社員の離職を抑制したい。
- **適正物量の算出**：ドライバーの力量によって適正物量が変動する。蓄積されたデータの平均値から適正物量を算出したい。
- **現行の限界**：既存アプリは実績の登録・貨物追跡が中心で、**スキル見極め**や**コース適正化**の仕組みが弱い。

---

## 2. ターゲット / ステークホルダー
- **弊社社長/協力会社様**：全体最適・手当の公平性・離職抑制
- **配車担当**：再配分の意思決定材料・是正のリードタイム短縮
- **ドライバー**：公正な評価・適正な負担

---

## 3. 提供価値
- 実績（配達件数/個数/走行距離/拘束時間 等）を**スコア化**して負担差を可視化。
- 可視化にもとづく**コース再編の意思決定支援**（初版は提案機能を省き、人手判断）。
- 蓄積されたデータの平均値から適正物量を算出。

---

## 4. 指標（KGI / KPI）
- **KGI（結果指標）**
  - 2026/03 までに「コース負担スコアの差分」を **10以下**（2025/12–2平均比）
- **KPI（先行指標）** ※UXに集中（再配車関連は対象外）
  - 実績の**日次入力率 ≥ 95%**
  - **ダッシュボード応答の P95 を計測・可視化**（初版はログ集計で可）
  - **2秒以内率 ≥ 90%**（体感速度の担保）
- **定義メモ**
  - **負担スコア**＝距離・件数・個数・拘束時間・遅延ペナルティの加重合算（詳細式は別紙）
  - **P95**＝全リクエストの95%がこの時間以下で処理される時間
  - **2秒以内率**＝`/dashboard` 応答が2秒以下の割合

---

## 5. 主要機能（MVP）
## 1 実績CRUD（役割に応じた権限制御）
- **Create**：日付／名前／コース／配達先／個数／走行距離／時間（※積み込み時間を除く）を登録
- **Read**：DB参照
- **Update**：DB修正、ドライバー情報修正、コース修正（権限に応じて）
- **Delete**：DB削除、ドライバー情報削除、コース削除（権限に応じて）

## 2 配達先登録
- 既存の集荷先を選択し、**個数**を入力 → 登録ボタンで **1件ごとの配達リスト**を作成

## 3 配達時間登録
- 配達リストの**「完了」ボタン**でステータスを「配達完了」へ変更すると、**現行時刻**を登録

## 4 負担仕事量スコア算出（実績→1〜3の手順で計算）

## 5 ダッシュボード
- コース／ドライバー別および全体の簡易グラフ
  - グラフ1：x軸＝**走行距離**、y軸＝**配達件数**
  - グラフ2：**Work / Density / Total**（カード＋簡易チャート）

## 6 PDF / CSV 出力
- 日々の実績を **PDF** と **CSV** で出力可能（期間・ドライバー・コースで絞り込み）

---

## 6. 負担スコアの根拠と計算方法
# 根拠

**初期値**：`S=5, P=0.7, T=1.5, α=0.3`
（式の再掲：`Work = S×件数 + P×個数`／`Density = 1 + α×max(0, km/停車 − T)`／`Total = Work × Density`）

## S（停車1件の基礎）= 5
- **定義**：1停車（1件）あたりの**固定作業コスト**
- **意味**：駐停車・呼び鈴/対面・署名/写真・端末操作など“必ず発生する手間”
- **単位の感覚**：pt（ポイント）。ここでは **1pt ≒ 1分相当**
- **初期値の根拠**：1件の固定作業は概ね **4〜6分** → 中央の **5分 ⇒ S=5**
- **補足**：**1件 ≒ 5pt** を基準線にする

## P（1個の追加）= 0.7
- **定義**：同一停車内で**個口が1つ増える**ごとの増分作業
- **意味**：宛名確認・持ち替え・スキャン・受け渡し等、個数に比例して増える手間
- **単位の感覚**：pt（＝分相当）
- **初期値の根拠**：1個あたり **約30〜60秒** → 中間の **0.7分 ⇒ P=0.7**
- **比率の直感**：`S/P = 5/0.7 ≈ 7.1` → **1件 ≈ 7個ぶん**

## T（しきい値；km/停車）= 1.5
- **定義**：**補正（Density）を掛け始める基準の疎密**。`km/停車 ≤ T` は補正なし（`Density=1`）
- **意味**：運行における**標準密度**（ここまでは普通＝補正不要）
- **単位の感覚**：km/停車（例：**T=1.5** → **1停車あたり1.5km** までは普通）
- **初期値の根拠**：`km/停車` の **P50〜P60**（中央値〜60パーセンタイル）を採用
  → **平均的な日は補正ゼロ**、**疎い日だけ補正**
- **注**：P＝パーセンタイル（百分位点）。P50＝中央値。

## α（感度；/（km/停車））= 0.3
- **定義**：**Tを超えた 1（km/停車）あたり**、`Density`（=補正倍率）を**どれだけ増やすか**の**傾き**
- **式との関係**：`Density = 1 + α × max(0, km/停車 − T)`
  - 例：`α=0.3` → **Tより 1（km/停車）大**きいごとに **+0.30（=+30%）**
- **単位の感覚**：おおよそ **“% /（km/停車）”**（例：30%/（km/停車））
- **初期値の根拠（1点合わせ）**
  1. `km/停車` の **P90** を“疎い代表点” **r** とする（例：`r=2.0`）
  2. その点で **補正倍率を +g%** にしたい（例：`g=15%` → `Density=1.15`）
  3. **α を逆算**：
     ```
     α = g / (r − T)
     ```
     例：`T=1.5, r=2.0, g=0.15` → `α = 0.15 / (2.0 − 1.5) = 0.3`
- **何を“増やす”のか**：増やすのは **`Density`（補正倍率）**。
  `Total = Work × Density` において、**Total を Work に対して +g%** 底上げする地点を **r** に取り、
  その意図を満たす **α** を上式で決める。

# 計算方法

### 1) Work（作業量ポイント）
```
Work = S × 配達完了件数 + P × 配達個数
```
- 採用理由（“件数 vs 個数”の悩みの解消）  
  「個数だけ」「件数だけ」では偏るため、**固定手間（件数）＋増分手間（個数）**を合算する。

**初期値の目安**：`S = 5`, `P = 0.7`

**例**
- ケース1：`Work = 5×60 + 0.7×100 = 370 pt`
- ケース2：`Work = 5×40 + 0.7×60  = 242 pt`
- ケース3：`Work = 5×20 + 0.7×30  = 121 pt`

### 2) Density（走行難易度・密度係数）
```
Density = 1 + α × max(0, km/停車 − T)
```
- 採用理由（山間部の不利を補正）
  山間部は「個数が少ないのに距離が長い」＝**走行時間比率が高い**ため、疎密（km/停車）に応じて **Work を倍率補正**する。

- **しきい値 T**：密度係数をかけ始める基準の疎密。`km/停車 ≤ T` なら補正なし（`Density = 1`）
- **感度 α**：疎密に対する**増分の強さ**。`α=0.3` なら **Tより 1（km/停車）**大きいごとに **+30%**

**初期値の目安**：`T = 1.5`, `α = 0.3`

**例**
- 都市部：`距離=40, 停車=60 → km/停車=0.667`
  `0.667−1.5<0 → Density=1 + 0.3×0 = 1.0`
- 準郊外：`距離=80, 停車=40 → km/停車=2.0`
  `2.0−1.5=0.5 → Density=1 + 0.3×0.5 = 1.15`
- 山間部：`距離=150, 停車=20 → km/停車=7.5`
  `7.5−1.5=6.0 → Density=1 + 0.3×6.0 = 2.8`

### 3) Total（負担仕事量）
```
Total = Work × Density
```

**例**
- ケース1：`Total = 370 × 1.0  = 370.0`
- ケース2：`Total = 242 × 1.15 = 278.3`
- ケース3：`Total = 121 × 2.8  = 338.8`

**負担の大きい順**：**1 > 3 > 2**


---

## 7. 非機能（品質・制約）要件
- **権限 / RBAC**
  - 役割：弊社社長＝全社閲覧＋承認、配車＝実績修正、ドライバー＝自分の実績のみ
  - 直URL/API直叩きでも**越権不可（403）**。重要操作は段階的に二段階承認へ拡張可能。
- **監査ログ（tamper-evident 最小実装）**
  - 対象：ログイン、実績CRUD、権限変更（誰/いつ/何を/旧→新/IP）
  - 形式：**JSON Lines** 追記専用。各行に `prev_hash` と **HMAC** を付与（改ざん検知）。
  - 運用：日次ローテーション→**アプリ外アカウントのリポジトリ**へ自動送信（削除権限なし）。
  - 将来：**S3 Object Lock（保持1年）** 等で改ざん防止（WORM）に移行。
- **性能**
  - `/dashboard` の処理時間（ms）をJSONログに出力→週次で **P95 / 2秒以内率** を可視化。
  - 一覧は**ページング（50件/ページ）**＋ `driver_id, date` の**複合INDEX** を付与。
  - 必要画面のみ `includes()` を使用し**N+1簡易回避**。
- **セキュリティ / 運用**
  - HTTPS、サーバ側入力検証（型/範囲/長さ/列挙/存在確認）、CSRF対策、出力エスケープ（ASVS指針に準拠）。
  - 構造化アプリログ、最低限のメトリクス（リク数/エラー率/処理時間）収集。
  - IaC/再現性（Docker Compose など）、ロールバック可能なデプロイ。

--

## 8. 技術スタック案
- **Backend**：Ruby on Rails
- **DB**：MySQL
- **Frontend**：HTML / CSS / JavaScript
- **ログ/計測**：アプリログ（JSONL）、簡易集計スクリプト（Ruby/シェル）

---

## 9. リスク・前提
- **スコア式の妥当性**：重み付けは現場ヒアリングで調整、毎月レビュー。
- **入力運用の徹底**：日次入力率95%を保つための周知とUI簡素化。
- **N+1/性能**：まずはページング＋基本インデックス。必要に応じて最適化を追加。

---

## プラスアルファ（将来的拡張機能）
- **地図表示（コースエリアの可視化）**
  - 収集した停止点（CSV/GPX）を取り込み、**点群 → 凸包（convex） → buffer(0.3–0.5km)** でコース面を自動生成。
  - Leaflet + turf.js で**点/線/面**を表示。必要箇所は**手動ポリゴン編集**で補正。
  - 将来：重なり調整（union/フィルタ）、コース検索、凡例整備。

---
## エレベーターピッチ（社長向け）

配送の負担の偏りと評価の不公平が離職と機会損失を生んでいるという課題に対して、経営層・拠点長・配車担当に向けて、logi-balance は「負担の見える化」による業務改善ツールとして提供します。

目的は、コース間の負担ばらつきを **10スコア以下** まで抑制し、実績に基づいたコース毎の **適正な物量** を見直すことです。

単なる実績記録ツールと異なり、毎日の実績を誰にでも分かる形で提示し、感覚ではなく **事実** に基づいて配分を是正できます。しかも導入は現場の運用を崩さず **小さく始められる** ため、効果検証と展開がスムーズです。

