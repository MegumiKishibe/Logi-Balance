# オリジナルプロジェクト考案書: logi-balance機能限定版（配達限定）

## 0. このアプリの概要

運送業界では、**配達コースごとの件数・個数・距離の偏り**がしばしば生じます。
この偏りが、ドライバー間の **業務負担や手当ての不公平感** につながり、職場の不満や早期離職の一因となっています。特に、発言力のあるベテランドライバーが負担の軽いコースを優先し、新人ドライバーに負担の大きい配達を任せる傾向が見られます。その結果、新人が十分に稼げず定着しにくいという課題があります。

そこで本アプリ「logi-balance」は、**コース間の配達負荷を可視化し、公平性を担保する仕組み**を提供します。
目的は、新人ドライバーが安心して働き続けられる環境をつくり、組織全体の定着率と効率性を高めることです。

---

### 前提条件

1. ドライバーの給料・手当の内訳には、**配達個数・集荷個数・能力給・年功序列・就労時間・販売奨励金**などが含まれる。
2. 一般的に **配達手当よりも集荷手当の方が高い**。
3. このため、ベテランが集荷を優先し、新人に配達を回す構造が生じやすい。
   → 本アプリでは、この不均衡を是正し、配分を「見える化」することで問題を抑制する。


## 1. 背景・課題
- **負担の偏り**：コースごとに負担が偏り、手当に不公平感が生じている。払拭されない不公平なコース割による新入社員の離職を抑制したい。
- **適正物量の算出**：ドライバーの力量によって適正物量が変動する。蓄積されたデータの平均値から適正物量を算出したい。
- **現行の限界**：既存アプリは実績の登録・貨物追跡が中心で、**スキル見極め**や**コース適正化**の仕組みが弱い。

## 2. ターゲット / ステークホルダー
- **弊社社長/協力会社様**：全体最適・手当の公平性・離職抑制
- **配車担当**：再配分の意思決定材料・是正のリードタイム短縮
- **ドライバー**：公正な評価・適正な負担

## 3. 提供価値
- 実績（配達件数/個数/走行距離/拘束時間 等）を**スコア化**して負担差を可視化。
- 可視化にもとづく**コース再編の意思決定支援**（初版は提案機能を省き、人手判断）。
- 蓄積されたデータの平均値から適正物量を算出。

## 4. 指標（KGI / KPI）
- **KGI（結果指標）**
  - 2026/03 までに「コース負担スコアの差分」を **10以下**（2025/12–2平均比）
- **KPI（先行指標）** ※UXに集中（再配車関連は対象外）
  - 実績の**日次入力率 ≥ 95%**
  - **ダッシュボード応答の P95 を計測・可視化**（初版はログ集計で可）
  - **2秒以内率 ≥ 90%**（体感速度の担保）
- **定義メモ**
  - **負担スコア**＝距離・件数・個数・拘束時間・遅延ペナルティの加重合算（詳細式は別紙）
  - **P95**＝全リクエストの95%がこの時間以下で処理される時間
  - **2秒以内率**＝`/dashboard` 応答が2秒以下の割合

## 5. 主要機能（MVP）
1. **実績CRUD**（日次の入力/参照/修正：役割に応じた権限制御）
2. **負担スコア算出**（実績からスコアを計算：SQL/バッチ）
3. **ダッシュボード**（コース/ドライバー別の指標カード・簡易グラフ）
4. **PDF.CSV出力** (実績をPDF、CSV形式で出力できる。)
5. **配達先自動登録**（配達先と配達個数を選択することで登録）
6. **配達時間登録**（リスト横の完了ボタンを押すことで登録）
7. **P95可視化**（リクエスト処理時間をログ出力→週次でP95/2秒以内率を集計表示）

## 6. 非機能（品質・制約）要件
- **権限 / RBAC**
  - 役割：弊社社長＝全社閲覧＋承認、配車＝実績修正、ドライバー＝自分の実績のみ
  - 直URL/API直叩きでも**越権不可（403）**。重要操作は段階的に二段階承認へ拡張可能。
- **監査ログ（tamper-evident 最小実装）**
  - 対象：ログイン、実績CRUD、権限変更（誰/いつ/何を/旧→新/IP）
  - 形式：**JSON Lines** 追記専用。各行に `prev_hash` と **HMAC** を付与（改ざん検知）。
  - 運用：日次ローテーション→**アプリ外アカウントのリポジトリ**へ自動送信（削除権限なし）。
  - 将来：**S3 Object Lock（保持1年）** 等で改ざん防止（WORM）に移行。
- **性能**
  - `/dashboard` の処理時間（ms）をJSONログに出力→週次で **P95 / 2秒以内率** を可視化。
  - 一覧は**ページング（50件/ページ）**＋ `driver_id, date` の**複合INDEX** を付与。
  - 必要画面のみ `includes()` を使用し**N+1簡易回避**。
- **セキュリティ / 運用**
  - HTTPS、サーバ側入力検証（型/範囲/長さ/列挙/存在確認）、CSRF対策、出力エスケープ（ASVS指針に準拠）。
  - 構造化アプリログ、最低限のメトリクス（リク数/エラー率/処理時間）収集。
  - IaC/再現性（Docker Compose など）、ロールバック可能なデプロイ。

## 7. 技術スタック案
- **Backend**：Ruby on Rails
- **DB**：MySQL
- **Frontend**：HTML / CSS / JavaScript
- **ログ/計測**：アプリログ（JSONL）、簡易集計スクリプト（Ruby/シェル）

## 8. リスク・前提
- **スコア式の妥当性**：重み付けは現場ヒアリングで調整、毎月レビュー。
- **入力運用の徹底**：日次入力率95%を保つための周知とUI簡素化。
- **N+1/性能**：まずはページング＋基本インデックス。必要に応じて最適化を追加。

---

## プラスアルファ（時間に余裕があれば実装したいこと）
- **地図表示（コースエリアの可視化）**
  - 収集した停止点（CSV/GPX）を取り込み、**点群 → 凸包（convex） → buffer(0.3–0.5km)** でコース面を自動生成。
  - Leaflet + turf.js で**点/線/面**を表示。必要箇所は**手動ポリゴン編集**で補正。
  - 将来：重なり調整（union/フィルタ）、コース検索、凡例整備。

---
## エレベーターピッチ（社長向け）

配送の負担の偏りと評価の不公平が離職と機会損失を生んでいるという課題に対して、経営層・拠点長・配車担当に向けて、logi-balance は「負担の見える化」による業務改善ツールとして提供します。

目的は、コース間の負担ばらつきを **10スコア以下** まで抑制し、実績に基づいたコース毎の **適正な物量** を見直すことです。

単なる実績記録ツールと異なり、毎日の実績を誰にでも分かる形で提示し、感覚ではなく **事実** に基づいて配分を是正できます。しかも導入は現場の運用を崩さず **小さく始められる** ため、効果検証と展開がスムーズです。

