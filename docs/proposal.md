# オリジナルプロジェクト考案書: logi-balance

## 1. 背景・課題
- **負担の偏り**：コースごとに負担が偏り、手当に不公平感が生じている。ベテランが収益性の高いコースを占有し、新人が育つ前に離職するリスク。
- **収益機会の取りこぼし**：コース間の負荷を均一化すれば、集荷余力のあるコースを発見し全体粗利を拡大できる。
- **評価の属人化**：ドライバー評価が管理職の“感覚”に依存。実績ベースで公平化したい。
- **現行の限界**：既存アプリは実績の登録・集計が中心で、**スキル見極め**や**コース適正化**の仕組みが弱い。

## 2. ターゲット / ステークホルダー
- **支店長/社長**：全体最適・手当の公平性・離職抑制
- **配車担当**：再配分の意思決定材料・是正のリードタイム短縮
- **ドライバー**：公正な評価・適正な負担

## 3. 提供価値
- 実績（集荷軒数/配達件数/個数/走行距離/拘束時間 等）を**スコア化**して負担差を可視化。
- 可視化にもとづく**コース再編の意思決定支援**（初版は提案機能を省き、人手判断）。
- 実績ベースの評価で公平性を担保し、管理職の評価負担を軽減。

## 4. 指標（KGI / KPI）
- **KGI（結果指標）**
  - 2026/03 までに「コース負担スコアの分散」を **30% 低下**（2025/10–12平均比）
- **KPI（先行指標）** ※UXに集中（再配車関連は対象外）
  - 実績の**日次入力率 ≥ 95%**
  - **ダッシュボード応答の P95 を計測・可視化**（初版はログ集計で可）
  - **2秒以内率 ≥ 90%**（体感速度の担保）
- **定義メモ**
  - **負担スコア**＝距離・件数・個数・拘束時間・遅延ペナルティの加重合算（詳細式は別紙）
  - **P95**＝全リクエストの95%がこの時間以下で処理される時間
  - **2秒以内率**＝`/dashboard` 応答が2秒以下の割合

## 5. 主要機能（MVP）
1. **実績CRUD**（日次の入力/参照/修正：役割に応じた権限制御）
2. **負担スコア算出**（実績からスコアを計算：SQL/バッチ）
3. **ダッシュボード**（コース/ドライバー別の指標カード・簡易グラフ）
4. **P95可視化**（リクエスト処理時間をログ出力→週次でP95/2秒以内率を集計表示）

## 6. 非機能（品質・制約）要件
- **権限 / RBAC**
  - 役割：支店長＝全社閲覧＋承認、配車＝実績修正、ドライバー＝自分の実績のみ
  - 直URL/API直叩きでも**越権不可（403）**。重要操作は段階的に二段階承認へ拡張可能。
- **監査ログ（tamper-evident 最小実装）**
  - 対象：ログイン、実績CRUD、権限変更（誰/いつ/何を/旧→新/IP）
  - 形式：**JSON Lines** 追記専用。各行に `prev_hash` と **HMAC** を付与（改ざん検知）。
  - 運用：日次ローテーション→**アプリ外アカウントのリポジトリ**へ自動送信（削除権限なし）。
  - 将来：**S3 Object Lock（保持1年）** 等で改ざん防止（WORM）に移行。
- **性能**
  - `/dashboard` の処理時間（ms）をJSONログに出力→週次で **P95 / 2秒以内率** を可視化。
  - 一覧は**ページング（50件/ページ）**＋ `driver_id, date` の**複合INDEX** を付与。
  - 必要画面のみ `includes()` を使用し**N+1簡易回避**。
- **セキュリティ / 運用**
  - HTTPS、サーバ側入力検証（型/範囲/長さ/列挙/存在確認）、CSRF対策、出力エスケープ（ASVS指針に準拠）。
  - 構造化アプリログ、最低限のメトリクス（リク数/エラー率/処理時間）収集。
  - IaC/再現性（Docker Compose など）、ロールバック可能なデプロイ。

## 7. データ収集（拡張機能）
- **実績データ**：手入力/CSV取込で収集（日次運用）。
- **（将来の地図用）停止点データ**：必要になった段階で以下を採用
  - **スマホ用ストップロガー（Web, アプリ不要）**  
    - `navigator.geolocation` を用い、停車地点を端末内保存→**CSVダウンロード**で提出。  
    - 列：`driver_id, course, ts, lat, lng, accuracy`

## 8. 技術スタック案
- **Backend**：Ruby on Rails
- **DB**：MySQL
- **Frontend**：HTML / CSS / JavaScript
- **ログ/計測**：アプリログ（JSONL）、簡易集計スクリプト（Ruby/シェル）

## 9. リスク・前提
- **スコア式の妥当性**：重み付けは現場ヒアリングで調整、毎月レビュー。
- **入力運用の徹底**：日次入力率95%を保つための周知とUI簡素化。
- **N+1/性能**：まずはページング＋基本インデックス。必要に応じて最適化を追加。

---

## プラスアルファ（時間に余裕があれば実装したいこと）
- **地図表示（コースエリアの可視化）**
  - 収集した停止点（CSV/GPX）を取り込み、**点群 → 凸包（convex） → buffer(0.3–0.5km)** でコース面を自動生成。
  - Leaflet + turf.js で**点/線/面**を表示。必要箇所は**手動ポリゴン編集**で補正。
  - 将来：重なり調整（union/フィルタ）、コース検索、凡例整備。

---
## エレベーターピッチ（社長向け）

配送の負担の偏りと評価の不公平が離職と機会損失を生んでいるという課題に対して、経営層・拠点長・配車担当に向けて、logi-balance は「負担の見える化」による業務改善ツールとして提供します。

目的は、コース間の負担ばらつきを **30％低減** し、公平な評価で離職を防ぎ、集荷の余力を見つけて **売上の伸び** につなげることです。

単なる実績記録ツールと異なり、毎日の実績を誰にでも分かる形で提示し、感覚ではなく **事実** に基づいて配分を是正できます。しかも導入は現場の運用を崩さず **小さく始められる** ため、効果検証と展開がスムーズです。


