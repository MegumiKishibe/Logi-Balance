# オリジナルプロジェクト考案書: logi-balance（配達限定・機能限定版）

## 0. 概要

運送現場では **配達コースごとの件数・個数・距離の偏り** が生じやすく、結果として **ドライバー間の負担・手当の不公平感** を生み、定着率の低下につながっています。発言力のあるベテランドライバーに負担が偏り、新人が高負担・低収入になりがちな構造も課題です。

**logi-balance(ロジバランス)** は、コース間の配達負荷を定量化・可視化し、**公平な配分判断を支援**するツールです。新人が安心して働き続けられる環境づくりと、組織全体の効率向上を目的とします。

### 前提
1. 給与・手当には **配達個数・集荷個数・能力給・年功序列・就労時間・販売奨励金** 等が影響する。
2. 一般的に **集荷手当の単価は配達手当より高い**。
3. その結果、ベテランは集荷を優先し、新人は配達偏重になりやすい。→ 本ツールはこの不均衡を **「見える化」** により抑制します。

---

## 1. 背景・課題
- **負担の偏り**：コースごとの負担差が手当の不公平感を生み、新人離職につながる。
- **適正物量の算出**：ドライバーの力量に応じた適正物量を **実績データの平均/分布** から算出したい。
- **現行の限界**：既存アプリは実績登録・追跡中心で、**スキル見極め** と **コース適正化** の仕組みが弱い。

---

## 2. ターゲット / ステークホルダー
- **経営層/協力会社**：全体最適、公平性、離職抑制
- **配車担当**：再配分判断の材料、是正リードタイム短縮
- **ドライバー**：公正な評価、適正な負担配分

---

## 3. 提供価値
- 実績（件数/個数/距離/拘束時間 等）を **スコア化** し、負担差を可視化
- 可視化結果に基づく **コース再編の意思決定支援**（初版は提案機能なし・人手判断）
- 蓄積データの平均から **適正物量の提示**

---

## 4. 主要機能（MVP）
### 4.1 実績 CRUD
- **Create**：日付／ドライバー名／コース／配達先／個数／距離／時間（積込除外）  
- **Read/Update/Delete**：実績・ドライバー・コースを参照/更新/削除

### 4.2 配達先登録
- 既存の配達先から選択し **個数** を入力 → **配達リスト（1件単位）** を生成

### 4.3 配達時間登録
- リストの **「完了」** でステータスを配達完了に更新し **現時刻** を記録

### 4.4 負担スコア算出
- 実績データ（5.1〜5.3）を用い **Work/Density/Total** を計算

### 4.5 ダッシュボード
- コース別/ドライバー別/全体の簡易グラフ  
  - グラフ1：x＝距離、y＝件数  
  - グラフ2：**Work / Density / Total**（カード＋ミニチャート）

### 4.6 PDF / CSV 出力
- 期間・ドライバー・コースで絞り、PDF/CSV を出力

---

## 5. 非機能要件（Quality Attributes）

### 5.1 セキュリティ
1) **HTTPS（通信の暗号化）**  
   - 本番は常時 HTTPS。HTTP は HTTPS へリダイレクト。  
2) **サーバ側入力検証（バリデーション）**  
   - 型/範囲/長さ/必須の確認。異常値で壊れない堅牢性を担保。

### 5.2 性能
- **一覧はページング（50件/ページ）**  
  - 全件読み出しによるメモリ/DB 負荷を回避。  
  - **Kaminari** で実装：コントローラ `.page(params[:page]).per(50)`、ビュー `<%= paginate @records %>`。  
- **複合インデックス（`driver_id, date`）**  
  - 「ドライバー×日付範囲」検索を高速化。  
  - 例（MySQL/Rails）：
    ```rb
    # db/migrate/xxxxxxxxxx_add_index_deliveries_on_driver_id_and_date.rb
    class AddIndexDeliveriesOnDriverIdAndDate < ActiveRecord::Migration[7.1]
      def change
        add_index :deliveries, [:driver_id, :date], name: 'idx_deliveries_driver_date'
      end
    end
    ```
    ```rb
    # app/controllers/deliveries_controller.rb
    class DeliveriesController < ApplicationController
      def index
        from = params[:from]
        to   = params[:to]
        @deliveries = Delivery
          .where(driver_id: params[:driver_id], date: from..to)
          .order(date: :desc)
          .page(params[:page]).per(50)
      end
    end
    ```
- **N+1 回避（必要画面のみ `includes`）**  
  - 一覧で `delivery.driver.name` 等をループ表示する場合は事前読込：
    ```rb
    @deliveries = Delivery
      .includes(:driver, :route, { stops: :destination })
      .for_driver(params[:driver_id])
      .within(params[:from], params[:to])
      .order(date: :desc)
      .page(params[:page]).per(50)
    ```
### 5.3 SLO（Service Level Objectives｜初期版・手動評価）

- Performance（/dashboard）
  - P95 応答時間 ≤ 2,000 ms（週次集計で確認）
  - 2秒以内率（/dashboard 応答 ≤ 2,000ms） ≥ 90%（週次集計で確認）

- Error
  - アプリケーション 5xx 率 < 1.0%（週次集計で確認）

> 注：初期版は「自動アラートなし」。数値は週1回の手動集計で評価する。

### 5.4 Observability（実装概要）
- 本番ログを JSON Lines（lograge）で出力し、各リクエストの `duration_ms` を記録
- 週次 Rake タスク（`rails metrics:weekly`）で `/dashboard` の **P95** と **2秒以内率** を算出し、`log/metrics_weekly.csv` に追記
- 管理画面 `/admin/metrics` に最新値を表示（目標達成時は緑バッジ）

### 実装位置
- 依存：`Gemfile`（lograge）  
- 設定：`config/environments/production.rb`（JSON出力＋duration_ms）  
- 集計：`lib/tasks/metrics.rake`（P95/2秒以内率）  
- 可視化：`config/routes.rb` / `app/controllers/admin/metrics_controller.rb` / `app/views/admin/metrics/index.html.erb`

---

## 6. 技術スタック（想定）
- **Backend**：Ruby on Rails  
- **Database**：MySQL  
- **Frontend**：HTML / CSS / JavaScript  
- **ログ/計測**：JSON Lines 形式のアプリログ、簡易集計スクリプト（Ruby/シェル）

---

## 7. リスクと前提
- **スコア式の妥当性**：現場ヒアリングに基づき重みを調整。月次レビューで継続改善。  
- **入力運用の徹底**：日次入力率 95%以上を達成するため、UI簡素化と周知を実施。  
- **性能**：ページング＋基本インデックスを優先導入。

## 8. 将来拡張（プラスアルファ）
- **地図表示によるコース可視化**  
  - 停止点（CSV/GPX）を取り込み、点群→凸包→バッファでコース面を自動生成。  
  - Leaflet + turf.js により点/線/面を表示。必要箇所は手動ポリゴンで補正。  

---

## エレベーターピッチ（経営層向け）
配達負担の偏りと評価の不公平による離職・機会損失という課題に対し、**logi-balance** は負担の「見える化」によって **公正な配分判断** を支援する業務改善ツールです。  
**コース間の負担ばらつきを 10 スコア以下** に抑え、実績データに基づく **適正物量の見直し** を可能にします。単なる実績記録ではなく、**事実に基づく是正** を促進し、現場運用を崩さず **小さく導入して効果検証** できる点が特長です。

---
<details>
  <summary><h2>Appendix A. 負担スコアの根拠と計算詳細 </h2></summary>

**初期パラメータ（暫定）**：`S=5, P=0.7, T=1.5, α=0.3`  
- `Work = S×件数 + P×個数`  
- `Density = 1 + α × max(0, km/停車 − T)`  
- `Total = Work × Density`

### A.1 係数の意味と根拠
**S（停車1件の基礎）= 5**  
- 1件あたりの固定作業（駐停車、対面、署名、端末操作 等）  
- 単位：pt（≒分相当）。4〜6分の中央値より **5pt** を採用

**P（1個の追加）= 0.7**  
- 同一停車内で1個増えるごとの増分作業（持ち替え、スキャン 等）  
- 30〜60秒の中間より **0.7pt**。直感：`S/P ≈ 7.1` → **1件 ≒ 7個**

**T（しきい値；km/停車）= 1.5**  
- 疎密補正を開始する基準密度（ここまでは補正なし）  
- 事前分布の P50〜P60（中央値近傍）を採用

**α（感度；/（km/停車））= 0.3**  
- `T` 超過 1（km/停車）あたりの増分倍率  
- 例：疎い代表点 `r=P90=2.0` で +15% を狙う → `α = 0.15 / (2.0 − 1.5) = 0.3`

### A.2 計算手順
**1) Work（作業量ポイント）**  
```
Work = S × 配達完了件数 + P × 配達個数
```
- 例：`S=5, P=0.7`  
  - ケース1：`5×60 + 0.7×100 = 370 pt`  
  - ケース2：`5×40 + 0.7×60  = 242 pt`  
  - ケース3：`5×20 + 0.7×30  = 121 pt`

**2) Density（走行難易度・密度係数）**  
```
Density = 1 + α × max(0, km/停車 − T)
```
- 例：`T=1.5, α=0.3`  
  - 都市部：`km/停車=0.667 → 1.0`  
  - 準郊外：`2.0 → 1 + 0.3×0.5 = 1.15`  
  - 山間部：`7.5 → 1 + 0.3×6.0 = 2.8`

**3) Total（総合負担）**  
```
Total = Work × Density
```
- 例：  
  - ケース1：`370 × 1.0  = 370.0`  
  - ケース2：`242 × 1.15 = 278.3`  
  - ケース3：`121 × 2.8  = 338.8`  
  → 負担の大きい順：**1 > 3 > 2**

### A.3 運用ポリシー（妥当性担保）
- **初期値は仮置き**：現場データ（月次）で再推定
- **変更管理**：重み変更は月次レビューで合意、変更履歴をバージョン管理

</details>

<details>
  <summary><h2>4. 指標（KGI/KPI） </h2></summary>
- **KGI（最終成果）**  
  - 2026/03 までに **コース負担スコア差分 ≤ 10**（2025/12–02 平均比）
- **KPI（先行指標｜UX中心）**  
  - 実績の **日次入力率 ≥ 95%**  
  - **ダッシュボード応答の P95 を記録・可視化**（初版はログ集計）  
  - **2秒以内率 ≥ 90%**
- **用語定義**  
  - **負担スコア**：距離・件数・個数・拘束時間の加重合算（詳細はAppendix A を参照）  
  - **P95**：全リクエストの95%がこの時間以下で処理される値  
  - **2秒以内率**：`/dashboard` 応答が2秒以下の割合

</details>
