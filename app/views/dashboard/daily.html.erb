<div class="title-group">
  <div class="title">
    <p2>Dashboard</p2>
    <p3>| <%= @delivery_route.name %> (Daily)</p3>
  </div>
</div>

<div class="dashboard-tabs">
  <%= link_to "全日（日別）", dashboard_path(@delivery_route), class: "dash-tab #{action_name == 'index' ? 'active' : ''}" %>
  <%= link_to "単日実績", daily_dashboard_path(@delivery_route, date: @date), class: "dash-tab #{action_name == 'daily' ? 'active' : ''}" %>
</div>

<div class="filter-section">
  <%= form_with url: daily_dashboard_path(@delivery_route), method: :get, local: true, class: "field-row" do %>
    <label class="form-label">表示日：</label>
    <div class="select-wrapper">
      <%= select_tag :date, options_for_select(@dates, @date), onchange: "this.form.submit()", class: "form-select" %>
    </div>
  <% end %>
</div>

<table class="table">
  <thead>
    <tr>
      <th>配達先</th>
      <th>件数</th>
      <th>個数</th>
      <th>完了時間</th>
    </tr>
  </thead>
  <tbody>
    <% if @stops.present? %>
      <% @stops.each do |stop| %>
        <tr>
          <td><strong><%= stop.destination.name %></strong></td>
          <td><%= stop.packages_count %> 件</td>
          <td><%= stop.pieces_count %> 個</td>
          <td class="time-highlight"><%= stop.completed_at&.in_time_zone("Asia/Tokyo")&.strftime("%H:%M") %></td>
        </tr>
      <% end %>
    <% else %>
      <tr>
        <td colspan="4" class="text-center">該当する配達データがありません。</td>
      </tr>
    <% end %>
  </tbody>
</table>

<div class="summary-container">
  <div class="summary-item">
    <span class="summary-label">合計件数</span>
    <span class="summary-value"><%= @stops&.count || 0 %>件</span>
  </div>
  <div class="summary-item">
    <span class="summary-label">合計個数</span>
    <span class="summary-value"><%= @stops&.sum(:pieces_count) || 0 %>個</span>
  </div>
  <div class="summary-item">
    <span class="summary-label">走行距離</span>
    <span class="summary-value">
      <% if @daily_course_run.present? %>
        <%= @daily_course_run.odo_end_km - @daily_course_run.odo_start_km %>km
      <% else %>
        -
      <% end %>
    </span>
  </div>
  <div class="summary-item">
    <span class="summary-label">所要時間</span>
    <span class="summary-value">
      <% if @stops.present? && @stops.first.completed_at && @stops.last.completed_at %>
        <%= (@stops.last.completed_at - @stops.first.completed_at).to_i / 60 %>分
      <% else %>
        -
      <% end %>
    </span>
  </div>
  <div class="summary-item">
    <span class="summary-label">負担ポイント</span>
    <span class="summary-value">
      <%= @daily_course_run&.daily_course_run_score_snapshots&.last&.total_score || "-" %>
    </span>
  </div>
</div>

<div class="nav-button-group">
  <%= link_to "コース選択画面へ戻る", courses_dashboard_index_path, class: "btn btn-secondary" %>
  <%= link_to "CSVダウンロード",
      daily_dashboard_path(@delivery_route, date: @date, format: :csv),
      class: "btn btn-primary" %>
</div>
